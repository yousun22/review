<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë¬¼ì¸í„°ë„· ë¬¼ê¼¬ - 5grains</title>
    <link rel="stylesheet" href="/css/home/toggle4.css">
</head>
<body>
    <div class="card-container">
        <% devices.forEach(device => { %>
            <div class="card" id="card-<%= device.hashNum %>">
                <div class="card-header">
                    <div class="loca-id"><%= device.loca_id %></div>
                    <div class="location">
                        <%= device.location %>
                        <a href="https://map.naver.com/p/search/<%= encodeURIComponent(device.location) %>" 
                            target="_blank" 
                            title="ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°"
                            style="margin-left: -2px; text-decoration: none;">
                            ğŸŒ
                         </a>
                    </div>
                </div>
                <div class="water-level">
                    <span id="data-<%= device.hashNum %>">
                       <%= ((device.waterLevel || 0) - (device.zeroPoint || 0)).toFixed(1) %>
                    </span> cm
                    <span id="state-<%= device.hashNum %>">-</span>
                </div>
                <div class="control-buttons">
                    <button type="button" class="valve-btn" onclick="toggleValve('<%= device.hashNum %>')" id="btn-<%= device.hashNum %>">...</button>
                    <button type="button" class="zero-btn" onclick="sendZeroPoint('<%= device.hashNum %>')" id="zero-<%= device.hashNum %>">ì˜ì </button>
                    <span class="timer-text" id="timer-<%= device.hashNum %>"></span>
                </div>
            </div>
        <% }); %>
    </div>
    <div id="device-data" data-devices='<%- JSON.stringify(devices).replace(/'/g, "&#39;") %>'></div> 

    <script>
        const devices = JSON.parse(document.getElementById("device-data").dataset.devices);
        const valveStates = {};
        const valveLockStates = {};  // ğŸ” ë°˜ë“œì‹œ í•„ìš”!
    
        console.log("âœ… devices ë¡œë“œë¨:", devices);
    
        // SSE ì—°ê²°
        const eventSource = new EventSource('/events/all');
        eventSource.onmessage = function (e) {
            try {
                const allData = JSON.parse(e.data);
                for (const hashNum in allData) {
                    updateDeviceUI(hashNum, allData[hashNum]);
                }
            } catch (err) {
                console.error("[SSE íŒŒì‹± ì˜¤ë¥˜]", err, e.data);
            }
        };
        eventSource.onerror = function (err) {
            console.error("SSE ì—°ê²° ì˜¤ë¥˜:", err);
        };
    
        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateValveButton(hashNum) {
            const btn = document.getElementById(`btn-${hashNum}`);
            if (!btn) return;
    
            const state = valveStates[hashNum];
            btn.textContent = state === "OPEN" ? "ë‹«ê¸°" : "ì—´ê¸°";
            btn.classList.toggle("open-btn", state !== "OPEN");
            btn.classList.toggle("close-btn", state === "OPEN");
    
            console.log(`ğŸ”„ [${hashNum}] updateValveButton() - ì ê¸ˆ ìƒíƒœ:`, valveLockStates[hashNum]);
            btn.disabled = !!valveLockStates[hashNum];
            console.log(`â›” btn.disabled ìµœì¢…ê°’: ${btn.disabled}`);
        }
    
        // ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        function toggleValve(hashNum) {
            if (valveLockStates[hashNum]) {
                console.warn(`â³ ${hashNum}ëŠ” ì ê¸ˆ ì¤‘`);
                return;
            }

            const isOpen = valveStates[hashNum] !== "OPEN";
            const btn = document.getElementById(`btn-${hashNum}`);
            const timerSpan = document.getElementById(`timer-${hashNum}`);
            const zeroBtn = document.getElementById(`zero-${hashNum}`);

            if (!btn || !timerSpan || !zeroBtn) {
                console.warn(`âš ï¸ ë²„íŠ¼ ìš”ì†Œ ëˆ„ë½: hashNum=${hashNum}`, { btn, timerSpan, zeroBtn });
                return;
            }

            valveLockStates[hashNum] = true;
            updateValveButton(hashNum);
            zeroBtn.disabled = true;

            fetch('/update_toggle_state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hashNum, toggleState: isOpen })
            }).then(res => {
                if (res.ok) {
                    let countdown = 35;
                    timerSpan.innerText = `(${countdown})`;

                    const intervalId = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            timerSpan.innerText = `(${countdown})`;
                        } else {
                            clearInterval(intervalId);
                            timerSpan.innerText = '';
                            valveLockStates[hashNum] = false;
                            updateValveButton(hashNum);
                            zeroBtn.disabled = false; // âœ… ë³µì›
                        }
                    }, 1000);
                } else {
                    console.error('âŒ ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨');
                    restoreButtons(hashNum);
                }
            }).catch((err) => {
                console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', err);
                restoreButtons(hashNum);
            });

            function restoreButtons(hashNum) {
                valveLockStates[hashNum] = false;
                updateValveButton(hashNum);
                zeroBtn.disabled = false;
                timerSpan.innerText = '';
            }
        }


        function updateDeviceUI(hashNum, data) {
            const waterLevelSpan = document.getElementById(`data-${hashNum}`);
            const stateSpan = document.getElementById(`state-${hashNum}`);
            const valveStatus = (data.actualValveState || '').toUpperCase();

            // ğŸ§  ìˆ˜ìœ„ ë³´ì •
            const MAX_LEVEL = 12.7;  // ì„¼ì„œê°€ ìµœëŒ€ ì¸ì‹í•˜ëŠ” ìˆ˜ìœ„ê°’(cm)
            const levelRaw = Number(data.waterLevel || 0);
            const zeroPoint = Number(data.zeroPoint || 0) / 100;

            //let level = levelRaw - zeroPoint;
            let level;
            // if (levelRaw < zeroPoint) {
            //     level = MAX_LEVEL - (zeroPoint - levelRaw);  // â†’ í•œ ë°”í€´ ëŒì•„ì˜¨ ê²ƒ
            // } else {
            //     level = levelRaw - zeroPoint;
            // }
            if (levelRaw < zeroPoint) {
                level = zeroPoint - levelRaw;  // â†’ í•œ ë°”í€´ ëŒì•„ì˜¨ ê²ƒ
            } else {
                level = MAX_LEVEL-levelRaw + zeroPoint;
            }
            if (level >= 12.5 && level <= 12.7) {
                level = 0;
            }

            if (waterLevelSpan) {
                waterLevelSpan.innerText = isNaN(level) ? "0.0" : level.toFixed(1);
            }

            if (stateSpan) {
                stateSpan.innerText = valveStatus === "OPEN" ? "ì—´ë¦¼" : "ë‹«í˜";
            }

            valveStates[hashNum] = valveStatus;
            updateValveButton(hashNum);
        }



    let selectedHashNumForZero = null;

    function sendZeroPoint(hashNum) {
        selectedHashNumForZero = hashNum;
        document.getElementById("zeroModal").style.display = "block";
    }

    function closeZeroModal() {
        document.getElementById("zeroModal").style.display = "none";
        selectedHashNumForZero = null;
    }

    function confirmZeroPoint() {
        if (!selectedHashNumForZero) return;

        fetch('/zero_point', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hashNum: selectedHashNumForZero })
        }).then(res => {
            if (res.ok) {
                alert(`âœ… [${selectedHashNumForZero}] ì˜ì  ë³´ì • ì „ì†¡ ì™„ë£Œ`);
            } else {
                alert(`âŒ [${selectedHashNumForZero}] ë³´ì • ì‹¤íŒ¨`);
            }
            closeZeroModal();
        }).catch(err => {
            console.error(err);
            alert("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
            closeZeroModal();
        });
    }

    </script>
    <div id="zeroModal" class="modal">
        <div class="modal-content">
            <p>ì˜ì ì„ ë§ì¶”ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-buttons">
                <button class="gray-btn" onclick="confirmZeroPoint()">ì˜ˆ</button>
                <button class="gray-btn" onclick="closeZeroModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</body>
</html>
